<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>MineDock æ§åˆ¶å°</title>
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <script src="//unpkg.com/vue@3"></script>
    <script src="//unpkg.com/element-plus"></script>
    <script src="//unpkg.com/@element-plus/icons-vue"></script>

    <style>
        body {
            background-color: #f5f7fa;
            padding: 20px;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', sans-serif;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header {
            font-weight: bold;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .running {
            background-color: #67C23A;
        }

        .exited {
            background-color: #909399;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="header">
            <h2>ğŸ® MineDock Server Manager</h2>
            <el-button type="primary" :icon="Refresh" @click="fetchContainers" circle></el-button>
        </div>

        <el-card>
            <template #header>
                <div class="card-header">
                    <span>å®¹å™¨åˆ—è¡¨</span>
                </div>
            </template>

            <el-table :data="containers" style="width: 100%" v-loading="loading">

                <el-table-column prop="names" label="å®¹å™¨åç§°" width="180">
                    <template #default="scope">
                        <el-tag effect="dark">{{ scope.row.names }}</el-tag>
                    </template>
                </el-table-column>

                <el-table-column prop="image" label="é•œåƒ" width="220"></el-table-column>

                <el-table-column label="çŠ¶æ€" width="180">
                    <template #default="scope">
                        <span :class="['status-dot', scope.row.state == 'running' ? 'running' : 'exited']"></span>
                        {{ scope.row.state }} ({{ scope.row.status }})
                    </template>
                </el-table-column>

                <el-table-column label="æ“ä½œ">
                    <template #default="scope">
                        <el-button type="success" size="small" :disabled="scope.row.state === 'running'"
                            @click="handleAction(scope.row.id, 'start')">
                            å¯åŠ¨
                        </el-button>

                        <el-button type="danger" size="small" :disabled="scope.row.state !== 'running'"
                            @click="handleAction(scope.row.id, 'stop')">
                            åœæ­¢
                        </el-button>

                        <el-button type="info" size="small" @click="openConsole(scope.row.id)">
                            æ§åˆ¶å°
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>
        <el-dialog v-model="logVisible" title="ğŸ”´ å®æ—¶æ§åˆ¶å°" width="80%" :before-close="closeConsole">

            <div ref="logBox"
                style="background: #1e1e1e; color: #2ecc71; padding: 15px; height: 400px; overflow-y: auto; font-family: monospace; white-space: pre-wrap; font-size: 14px; border-radius: 5px;">
                <div v-for="(line, index) in logs" :key="index" :style="line.style">
                    {{ line.text }}
                </div>
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue;
        const { ElMessage } = ElementPlus;
        const { Refresh } = ElementPlusIconsVue;
        const logVisible = ref(false); // å¼¹çª—å¼€å…³
        const logs = ref([]);          // å­˜æ—¥å¿—å†…å®¹
        const logBox = ref(null);      // ç»‘å®š DOM å…ƒç´ ï¼Œç”¨äºè‡ªåŠ¨æ»šåŠ¨
        let socket = null;             // WebSocket å®ä¾‹

        const openConsole = (id) => {
            logs.value = []; // æ¸…ç©ºæ—§æ—¥å¿—
            logVisible.value = true;

            // å»ºç«‹ WebSocket è¿æ¥
            // æ³¨æ„ï¼šå¦‚æœæ˜¯æœ¬åœ°å¼€å‘ï¼Œåœ°å€æ˜¯ ws://localhost:8080/containers/...
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${location.host}/containers/${id}/logs`;

            socket = new WebSocket(wsUrl);

            socket.onopen = () => {
                logs.value.push(">>> è¿æ¥æˆåŠŸï¼Œæ­£åœ¨æ¥å…¥ç¥ç»å…ƒç½‘ç»œ... <<<");
            };

            socket.onmessage = (event) => {
                try {
                    // è§£æåç«¯å‘æ¥çš„ JSON
                    const data = JSON.parse(event.data);

                    // æ ¹æ®ç±»å‹ç»™é¢œè‰²
                    let colorStyle = "color: #bdc3c7;"; // é»˜è®¤æµ…ç°è‰²
                    if (data.type === 'error') {
                        colorStyle = "color: #ff5555;"; // çº¢è‰²è­¦å‘Š
                    } else if (data.content.includes("INFO")) {
                        colorStyle = "color: #2ecc71;"; // INFO ä¿¡æ¯ç»™ç»¿è‰²
                    }

                    // ç”¨ HTML ä¹Ÿå°±æ˜¯ v-html æˆ–è€…ç›´æ¥æ‹¼ style å¯¹è±¡å­˜å…¥æ•°ç»„
                    // è¿™é‡Œä¸ºäº†ç®€å•ï¼Œæˆ‘ä»¬å­˜å¯¹è±¡ï¼Œæ”¹ä¸€ä¸‹ä¸Šé¢çš„ v-for
                    logs.value.push({ text: data.content, style: colorStyle });

                } catch (e) {
                    // ä¸‡ä¸€è§£æå¤±è´¥ï¼ˆæ¯”å¦‚ Docker å‘äº†éæ ‡å‡†åŒ…ï¼‰ï¼Œç›´æ¥æ˜¾ç¤ºåŸæ–‡
                    logs.value.push({ text: event.data, style: "color: #bdc3c7;" });
                }

                // è‡ªåŠ¨æ»šåŠ¨...
                nextTick(() => { /* ...ä¿æŒä¸å˜... */ });
            };

            socket.onclose = () => {
                logs.value.push(">>> è¿æ¥å·²æ–­å¼€ <<<");
            };
        };

        const closeConsole = (done) => {
            if (socket) {
                socket.close(); // å…³æ‰è¿æ¥
            }
            done();
        };

        const app = createApp({
            setup() {
                const containers = ref([]);
                const loading = ref(false);

                // è·å–åˆ—è¡¨
                const fetchContainers = () => {
                    loading.value = true;
                    fetch('/containers')
                        .then(res => res.json())
                        .then(data => {
                            containers.value = data;
                            loading.value = false;
                        })
                        .catch(err => {
                            ElMessage.error('è·å–åˆ—è¡¨å¤±è´¥');
                            loading.value = false;
                        });
                };

                // æ‰§è¡Œæ“ä½œ (å¯åŠ¨/åœæ­¢)
                const handleAction = (id, action) => {
                    loading.value = true; // æ“ä½œæ—¶æ˜¾ç¤ºåŠ è½½ä¸­
                    fetch(`/containers/${id}/${action}`, { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                ElMessage.error(data.error);
                            } else {
                                ElMessage.success(action === 'start' ? 'å¯åŠ¨æŒ‡ä»¤å·²å‘é€' : 'åœæ­¢æŒ‡ä»¤å·²å‘é€');
                                // å»¶è¿Ÿ 1 ç§’åˆ·æ–°åˆ—è¡¨ï¼Œç­‰å¾… Docker çŠ¶æ€æ›´æ–°
                                setTimeout(fetchContainers, 1000);
                            }
                        })
                        .catch(err => {
                            ElMessage.error('è¯·æ±‚å¤±è´¥');
                            loading.value = false;
                        });
                };

                onMounted(() => {
                    fetchContainers();
                });

                return {
                    containers,
                    loading,
                    fetchContainers,
                    handleAction,
                    Refresh,
                    logVisible,
                    logs,
                    logBox,
                    openConsole,
                    closeConsole
                };
            }
        });

        app.use(ElementPlus);
        // æ³¨å†Œå›¾æ ‡
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.mount('#app');
    </script>
</body>

</html>