<!DOCTYPE html>
<html lang="zh">

<head>
    <meta charset="UTF-8">
    <title>MineDock æ§åˆ¶å°</title>
    <link rel="stylesheet" href="//unpkg.com/element-plus/dist/index.css" />
    <script src="//unpkg.com/vue@3"></script>
    <script src="//unpkg.com/element-plus"></script>
    <script src="//unpkg.com/@element-plus/icons-vue"></script>

    <style>
        body {
            background-color: #f5f7fa;
            padding: 20px;
            font-family: 'Helvetica Neue', Helvetica, 'PingFang SC', sans-serif;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-header {
            font-weight: bold;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .running {
            background-color: #67C23A;
        }

        .exited {
            background-color: #909399;
        }
    </style>
</head>

<body>
    <div id="app">
        <div class="header">
            <h2>ğŸ® MineDock Server Manager</h2>
            <el-button type="primary" :icon="Refresh" @click="fetchContainers" circle></el-button>
        </div>

        <el-card>
            <template #header>
                <div class="card-header">
                    <span>å®¹å™¨åˆ—è¡¨</span>
                </div>
            </template>

            <el-table :data="containers" style="width: 100%" v-loading="loading">

                <el-table-column prop="names" label="å®¹å™¨åç§°" width="180">
                    <template #default="scope">
                        <el-tag effect="dark">{{ scope.row.names }}</el-tag>
                    </template>
                </el-table-column>

                <el-table-column prop="image" label="é•œåƒ" width="220"></el-table-column>

                <el-table-column label="çŠ¶æ€" width="180">
                    <template #default="scope">
                        <span :class="['status-dot', scope.row.state == 'running' ? 'running' : 'exited']"></span>
                        {{ scope.row.state }} ({{ scope.row.status }})
                    </template>
                </el-table-column>

                <el-table-column label="æ“ä½œ">
                    <template #default="scope">
                        <el-button type="success" size="small" :disabled="scope.row.state === 'running'"
                            @click="handleAction(scope.row.id, 'start')">
                            å¯åŠ¨
                        </el-button>

                        <el-button type="danger" size="small" :disabled="scope.row.state !== 'running'"
                            @click="handleAction(scope.row.id, 'stop')">
                            åœæ­¢
                        </el-button>
                    </template>
                </el-table-column>
            </el-table>
        </el-card>
    </div>

    <script>
        const { createApp, ref, onMounted } = Vue;
        const { ElMessage } = ElementPlus;
        const { Refresh } = ElementPlusIconsVue;

        const app = createApp({
            setup() {
                const containers = ref([]);
                const loading = ref(false);

                // è·å–åˆ—è¡¨
                const fetchContainers = () => {
                    loading.value = true;
                    fetch('/containers')
                        .then(res => res.json())
                        .then(data => {
                            containers.value = data;
                            loading.value = false;
                        })
                        .catch(err => {
                            ElMessage.error('è·å–åˆ—è¡¨å¤±è´¥');
                            loading.value = false;
                        });
                };

                // æ‰§è¡Œæ“ä½œ (å¯åŠ¨/åœæ­¢)
                const handleAction = (id, action) => {
                    loading.value = true; // æ“ä½œæ—¶æ˜¾ç¤ºåŠ è½½ä¸­
                    fetch(`/containers/${id}/${action}`, { method: 'POST' })
                        .then(res => res.json())
                        .then(data => {
                            if (data.error) {
                                ElMessage.error(data.error);
                            } else {
                                ElMessage.success(action === 'start' ? 'å¯åŠ¨æŒ‡ä»¤å·²å‘é€' : 'åœæ­¢æŒ‡ä»¤å·²å‘é€');
                                // å»¶è¿Ÿ 1 ç§’åˆ·æ–°åˆ—è¡¨ï¼Œç­‰å¾… Docker çŠ¶æ€æ›´æ–°
                                setTimeout(fetchContainers, 1000);
                            }
                        })
                        .catch(err => {
                            ElMessage.error('è¯·æ±‚å¤±è´¥');
                            loading.value = false;
                        });
                };

                onMounted(() => {
                    fetchContainers();
                });

                return {
                    containers,
                    loading,
                    fetchContainers,
                    handleAction,
                    Refresh
                };
            }
        });

        app.use(ElementPlus);
        // æ³¨å†Œå›¾æ ‡
        for (const [key, component] of Object.entries(ElementPlusIconsVue)) {
            app.component(key, component)
        }
        app.mount('#app');
    </script>
</body>

</html>